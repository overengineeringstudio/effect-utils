# Architecture

## Workspace Structure

```
my-workspace/                                  <- megarepo root
├── megarepo.json                              <- declares members
├── megarepo.lock                              <- pinned commits (committed to git)
├── .envrc                                     <- sources generated env, uses devenv
├── .envrc.generated.megarepo                  <- generated by `mr generate nix`
├── repos/
│   ├── my-app -> ~/.megarepo/.../my-app/      <- symlink to store
│   │   ├── .git/
│   │   ├── package.json
│   │   └── src/
│   └── effect-utils -> ~/.megarepo/.../       <- symlink to store
│       ├── .git/
│       ├── genie/repo.ts
│       └── packages/@overeng/*/
└── .direnv/megarepo-nix/workspace/            <- generated nix workspace
    ├── flake.nix
    ├── my-app/
    └── effect-utils/
```

**Key points:**
- Repo symlinks point to `~/.megarepo/` (the global store)
- The nix workspace at `.direnv/megarepo-nix/workspace/` is a filtered copy for fast nix eval/builds
- Both are generated by megarepo commands

## Global Store Structure

```
~/.megarepo/
  github.com/
    owner/
      repo/
        .bare/                          # bare repository (shared git objects)
        refs/
          heads/
            main/                       # worktree for 'main' branch
            feature%2Ffoo/              # worktree for 'feature/foo' (URL-encoded)
          tags/
            v1.0.0/                     # worktree for tag
          commits/
            abc123.../                  # worktree for specific commit
```

## Composition Hierarchy

```
┌─────────────────────────────────────────────────────────────────┐
│                      effect-utils (foundation)                   │
│  - Core catalog (Effect, React, TypeScript, Vite, testing)      │
│  - TypeScript config utilities                                   │
│  - genie package (config generators)                            │
│  - Shared devenv task modules                                    │
└─────────────────────────────────────────────────────────────────┘
                              ▲
          ┌───────────────────┼───────────────────┐
          │                   │                   │
┌─────────┴─────────┐ ┌───────┴───────┐ ┌────────┴────────┐
│      lib-a        │ │     lib-b     │ │     my-app      │
│  + domain pkgs    │ │  + domain pkgs│ │  + app-specific │
└───────────────────┘ └───────────────┘ └─────────────────┘
```

Dependencies flow **upward**: repos import from their dependencies via `../` paths inside `repos/` (e.g., `repos/my-app` depends on `../effect-utils`).

## Multi-level Composition

When multiple repos depend on effect-utils:

```
my-workspace/
├── megarepo.json
├── repos/
│   ├── my-app/
│   ├── lib-a/
│   ├── lib-b/
│   └── effect-utils/       <- Only one copy, deduplicated
```

The megarepo ensures:
- Only one copy of each repo exists in the workspace
- Revision conflicts are detected and reported
- All repos can share the same dependency via relative paths

## Nested Megarepos

A megarepo can be a member of another megarepo. When this happens:

- **Outermost root**: The top-level megarepo (closest to `/`)
- **Nearest root**: The first megarepo found walking up from `$PWD`

Nested megarepos must be independent: a child megarepo works without its parent's context. This is enforced by:
- Not relying on parent's env vars
- Not depending on parent's workspace paths
- Running `mr sync` produces a working environment regardless of parent

See [requirements](../nix-devenv/requirements.md) R1, R2, R17.
