# Generated file - DO NOT EDIT
# Source: ci.yml.genie.ts

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  typecheck:
    runs-on:
      [namespace-profile-linux-x86-64, 'namespace-features:github.run-id=${{ github.run_id }}']
    defaults:
      run:
        shell: bash
    env:
      FORCE_SETUP: '1'
      CI: 'true'
      GITHUB_TOKEN: '${{ github.token }}'
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            extra-substituters = https://devenv.cachix.org
            extra-trusted-public-keys = devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw=
            access-tokens = github.com=${{ github.token }}
      - name: Enable Cachix cache
        uses: cachix/cachix-action@v16
        with:
          name: overeng-effect-utils
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      - name: Use pinned devenv from lock
        run: |
          DEVENV_REV=$(jq -r .nodes.devenv.locked.rev devenv.lock)
          if [ -z "$DEVENV_REV" ] || [ "$DEVENV_REV" = "null" ]; then
            echo '::error::devenv.lock missing .nodes.devenv.locked.rev'
            exit 1
          fi
          echo "DEVENV_REV=$DEVENV_REV" >> "$GITHUB_ENV"
          echo "Pinned devenv rev: $DEVENV_REV"
        shell: bash
      - name: Validate Nix store
        run: |
          if [ -z "${DEVENV_REV:-}" ]; then
            DEVENV_REV=$(jq -r .nodes.devenv.locked.rev devenv.lock)
          if [ -z "$DEVENV_REV" ] || [ "$DEVENV_REV" = "null" ]; then
            echo '::error::devenv.lock missing .nodes.devenv.locked.rev'
            exit 1
          fi
          fi

          resolve_devenv() {
            nix build --no-link --print-out-paths "github:cachix/devenv/$DEVENV_REV#devenv"
          }

          # Always append restrict-eval=false so caller-provided NIX_CONFIG keeps its settings.
          if [ -n "${NIX_CONFIG:-}" ]; then
            NIX_CONFIG_WITH_UNRESTRICTED_EVAL="$NIX_CONFIG"$'\n''restrict-eval = false'
          else
            NIX_CONFIG_WITH_UNRESTRICTED_EVAL='restrict-eval = false'
          fi

          # Temporary: capture complete diagnostics for #272 root-cause analysis.
          DIAG_ROOT="${RUNNER_TEMP:-/tmp}/nix-store-diagnostics-${GITHUB_JOB:-job}-${RUNNER_OS:-unknown}-${GITHUB_RUN_ATTEMPT:-0}"
          mkdir -p "$DIAG_ROOT"
          echo "NIX_STORE_DIAGNOSTICS_DIR=$DIAG_ROOT" >> "$GITHUB_ENV"

          {
            echo "timestamp_utc=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "runner_name=${RUNNER_NAME:-unknown}"
            echo "runner_os=${RUNNER_OS:-unknown}"
            echo "runner_arch=${RUNNER_ARCH:-unknown}"
            echo "github_job=${GITHUB_JOB:-unknown}"
            echo "github_run_id=${GITHUB_RUN_ID:-unknown}"
            echo "github_run_attempt=${GITHUB_RUN_ATTEMPT:-unknown}"
            echo "nix_user_conf_files=${NIX_USER_CONF_FILES:-}"
            echo ""
            echo "== uname -a =="
            uname -a || true
            if command -v sw_vers > /dev/null 2>&1; then
              echo ""
              echo "== sw_vers =="
              sw_vers || true
            fi
            echo ""
            echo "== nix --version =="
            nix --version || true
          } > "$DIAG_ROOT/environment.txt" 2>&1

          pre_resolve_log="$DIAG_ROOT/resolve-devenv-pre-repair.log"
          pre_info_log="$DIAG_ROOT/devenv-info-pre-repair.log"
          verify_log="$DIAG_ROOT/nix-store-verify-pre-repair.log"
          repair_log="$DIAG_ROOT/nix-store-verify-repair.log"
          post_resolve_log="$DIAG_ROOT/resolve-devenv-post-repair.log"
          post_info_log="$DIAG_ROOT/devenv-info-post-repair.log"

          if DEVENV_OUT=$(resolve_devenv 2>"$pre_resolve_log") && DEVENV_BIN="$DEVENV_OUT/bin/devenv" && NIX_CONFIG="$NIX_CONFIG_WITH_UNRESTRICTED_EVAL" "$DEVENV_BIN" info > "$pre_info_log" 2>&1; then
            echo "Nix store OK"
          else
            echo "::warning::Nix store validation failed, collecting diagnostics and repairing..."
            if ! nix-store --verify --check-contents > "$verify_log" 2>&1; then
              echo "::warning::nix-store --verify --check-contents reported issues (see diagnostics artifact)"
            fi
            if ! nix-store --verify --check-contents --repair > "$repair_log" 2>&1; then
              echo "::warning::nix-store --verify --check-contents --repair reported issues (see diagnostics artifact)"
            fi
            rm -rf ~/.cache/nix/eval-cache-*
            DEVENV_OUT=$(resolve_devenv 2>"$post_resolve_log")
            DEVENV_BIN="$DEVENV_OUT/bin/devenv"
            NIX_CONFIG="$NIX_CONFIG_WITH_UNRESTRICTED_EVAL" "$DEVENV_BIN" info > "$post_info_log" 2>&1
          fi

          echo "DEVENV_BIN=$DEVENV_BIN" >> "$GITHUB_ENV"
          "$DEVENV_BIN" version | tee "$DIAG_ROOT/devenv-version.txt"
        shell: bash
      - name: Type check
        run: "if [ -n \"${NIX_CONFIG:-}\" ]; then NIX_CONFIG_WITH_UNRESTRICTED_EVAL=\"$NIX_CONFIG\"$'\\n''restrict-eval = false'; else NIX_CONFIG_WITH_UNRESTRICTED_EVAL='restrict-eval = false'; fi; NIX_CONFIG=\"$NIX_CONFIG_WITH_UNRESTRICTED_EVAL\" \"${DEVENV_BIN:?DEVENV_BIN not set}\" tasks run ts:check --mode before"
      - name: Nix diagnostics summary
        if: failure()
        shell: bash
        run: |
          diag_dir="${NIX_STORE_DIAGNOSTICS_DIR:-}"
          if [ -z "$diag_dir" ] || [ ! -d "$diag_dir" ]; then
            echo "## Nix Store Diagnostics" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "No diagnostics directory found (validation may have failed before capture)." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          {
            echo "## Nix Store Diagnostics"
            echo ""
            echo "Temporary instrumentation for #272; remove after root cause is confirmed and CI is stable."
            echo ""
            echo "- Diagnostics directory: `$diag_dir`"
            echo "- Tracking issue: https://github.com/overengineeringstudio/effect-utils/issues/272"
          } >> "$GITHUB_STEP_SUMMARY"

          markers_file="$diag_dir/signature-markers.txt"
          grep -R -n -E "config\\.cachix|cachix\\.package|error: path '/nix/store/.+ is not valid" "$diag_dir" > "$markers_file" || true

          if [ -s "$markers_file" ]; then
            {
              echo ""
              echo "### Signature markers"
              echo "```text"
              sed -n "1,120p" "$markers_file"
              echo "```"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- No signature markers found in captured diagnostics." >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Upload Nix diagnostics artifact
        if: failure() && env.NIX_STORE_DIAGNOSTICS_DIR != ''
        uses: actions/upload-artifact@v4
        with:
          name: 'nix-store-diagnostics-${{ github.job }}-${{ runner.os }}-run-${{ github.run_id }}-attempt-${{ github.run_attempt }}'
          path: '${{ env.NIX_STORE_DIAGNOSTICS_DIR }}'
          if-no-files-found: ignore
          retention-days: 14
      - name: Failure note
        if: failure()
        shell: bash
        run: |
          echo "If this looks like Namespace runner Nix store corruption (e.g. \"... is not valid\", \"config.cachix\", \"cachix.package\"), add the run link + full nix-store output to:"
          echo "  https://github.com/overengineeringstudio/effect-utils/issues/201"
  lint:
    runs-on:
      [namespace-profile-linux-x86-64, 'namespace-features:github.run-id=${{ github.run_id }}']
    defaults:
      run:
        shell: bash
    env:
      FORCE_SETUP: '1'
      CI: 'true'
      GITHUB_TOKEN: '${{ github.token }}'
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            extra-substituters = https://devenv.cachix.org
            extra-trusted-public-keys = devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw=
            access-tokens = github.com=${{ github.token }}
      - name: Enable Cachix cache
        uses: cachix/cachix-action@v16
        with:
          name: overeng-effect-utils
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      - name: Use pinned devenv from lock
        run: |
          DEVENV_REV=$(jq -r .nodes.devenv.locked.rev devenv.lock)
          if [ -z "$DEVENV_REV" ] || [ "$DEVENV_REV" = "null" ]; then
            echo '::error::devenv.lock missing .nodes.devenv.locked.rev'
            exit 1
          fi
          echo "DEVENV_REV=$DEVENV_REV" >> "$GITHUB_ENV"
          echo "Pinned devenv rev: $DEVENV_REV"
        shell: bash
      - name: Validate Nix store
        run: |
          if [ -z "${DEVENV_REV:-}" ]; then
            DEVENV_REV=$(jq -r .nodes.devenv.locked.rev devenv.lock)
          if [ -z "$DEVENV_REV" ] || [ "$DEVENV_REV" = "null" ]; then
            echo '::error::devenv.lock missing .nodes.devenv.locked.rev'
            exit 1
          fi
          fi

          resolve_devenv() {
            nix build --no-link --print-out-paths "github:cachix/devenv/$DEVENV_REV#devenv"
          }

          # Always append restrict-eval=false so caller-provided NIX_CONFIG keeps its settings.
          if [ -n "${NIX_CONFIG:-}" ]; then
            NIX_CONFIG_WITH_UNRESTRICTED_EVAL="$NIX_CONFIG"$'\n''restrict-eval = false'
          else
            NIX_CONFIG_WITH_UNRESTRICTED_EVAL='restrict-eval = false'
          fi

          # Temporary: capture complete diagnostics for #272 root-cause analysis.
          DIAG_ROOT="${RUNNER_TEMP:-/tmp}/nix-store-diagnostics-${GITHUB_JOB:-job}-${RUNNER_OS:-unknown}-${GITHUB_RUN_ATTEMPT:-0}"
          mkdir -p "$DIAG_ROOT"
          echo "NIX_STORE_DIAGNOSTICS_DIR=$DIAG_ROOT" >> "$GITHUB_ENV"

          {
            echo "timestamp_utc=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "runner_name=${RUNNER_NAME:-unknown}"
            echo "runner_os=${RUNNER_OS:-unknown}"
            echo "runner_arch=${RUNNER_ARCH:-unknown}"
            echo "github_job=${GITHUB_JOB:-unknown}"
            echo "github_run_id=${GITHUB_RUN_ID:-unknown}"
            echo "github_run_attempt=${GITHUB_RUN_ATTEMPT:-unknown}"
            echo "nix_user_conf_files=${NIX_USER_CONF_FILES:-}"
            echo ""
            echo "== uname -a =="
            uname -a || true
            if command -v sw_vers > /dev/null 2>&1; then
              echo ""
              echo "== sw_vers =="
              sw_vers || true
            fi
            echo ""
            echo "== nix --version =="
            nix --version || true
          } > "$DIAG_ROOT/environment.txt" 2>&1

          pre_resolve_log="$DIAG_ROOT/resolve-devenv-pre-repair.log"
          pre_info_log="$DIAG_ROOT/devenv-info-pre-repair.log"
          verify_log="$DIAG_ROOT/nix-store-verify-pre-repair.log"
          repair_log="$DIAG_ROOT/nix-store-verify-repair.log"
          post_resolve_log="$DIAG_ROOT/resolve-devenv-post-repair.log"
          post_info_log="$DIAG_ROOT/devenv-info-post-repair.log"

          if DEVENV_OUT=$(resolve_devenv 2>"$pre_resolve_log") && DEVENV_BIN="$DEVENV_OUT/bin/devenv" && NIX_CONFIG="$NIX_CONFIG_WITH_UNRESTRICTED_EVAL" "$DEVENV_BIN" info > "$pre_info_log" 2>&1; then
            echo "Nix store OK"
          else
            echo "::warning::Nix store validation failed, collecting diagnostics and repairing..."
            if ! nix-store --verify --check-contents > "$verify_log" 2>&1; then
              echo "::warning::nix-store --verify --check-contents reported issues (see diagnostics artifact)"
            fi
            if ! nix-store --verify --check-contents --repair > "$repair_log" 2>&1; then
              echo "::warning::nix-store --verify --check-contents --repair reported issues (see diagnostics artifact)"
            fi
            rm -rf ~/.cache/nix/eval-cache-*
            DEVENV_OUT=$(resolve_devenv 2>"$post_resolve_log")
            DEVENV_BIN="$DEVENV_OUT/bin/devenv"
            NIX_CONFIG="$NIX_CONFIG_WITH_UNRESTRICTED_EVAL" "$DEVENV_BIN" info > "$post_info_log" 2>&1
          fi

          echo "DEVENV_BIN=$DEVENV_BIN" >> "$GITHUB_ENV"
          "$DEVENV_BIN" version | tee "$DIAG_ROOT/devenv-version.txt"
        shell: bash
      - name: Format + lint
        run: "if [ -n \"${NIX_CONFIG:-}\" ]; then NIX_CONFIG_WITH_UNRESTRICTED_EVAL=\"$NIX_CONFIG\"$'\\n''restrict-eval = false'; else NIX_CONFIG_WITH_UNRESTRICTED_EVAL='restrict-eval = false'; fi; NIX_CONFIG=\"$NIX_CONFIG_WITH_UNRESTRICTED_EVAL\" \"${DEVENV_BIN:?DEVENV_BIN not set}\" tasks run lint:check --mode before"
      - name: Nix diagnostics summary
        if: failure()
        shell: bash
        run: |
          diag_dir="${NIX_STORE_DIAGNOSTICS_DIR:-}"
          if [ -z "$diag_dir" ] || [ ! -d "$diag_dir" ]; then
            echo "## Nix Store Diagnostics" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "No diagnostics directory found (validation may have failed before capture)." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          {
            echo "## Nix Store Diagnostics"
            echo ""
            echo "Temporary instrumentation for #272; remove after root cause is confirmed and CI is stable."
            echo ""
            echo "- Diagnostics directory: `$diag_dir`"
            echo "- Tracking issue: https://github.com/overengineeringstudio/effect-utils/issues/272"
          } >> "$GITHUB_STEP_SUMMARY"

          markers_file="$diag_dir/signature-markers.txt"
          grep -R -n -E "config\\.cachix|cachix\\.package|error: path '/nix/store/.+ is not valid" "$diag_dir" > "$markers_file" || true

          if [ -s "$markers_file" ]; then
            {
              echo ""
              echo "### Signature markers"
              echo "```text"
              sed -n "1,120p" "$markers_file"
              echo "```"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- No signature markers found in captured diagnostics." >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Upload Nix diagnostics artifact
        if: failure() && env.NIX_STORE_DIAGNOSTICS_DIR != ''
        uses: actions/upload-artifact@v4
        with:
          name: 'nix-store-diagnostics-${{ github.job }}-${{ runner.os }}-run-${{ github.run_id }}-attempt-${{ github.run_attempt }}'
          path: '${{ env.NIX_STORE_DIAGNOSTICS_DIR }}'
          if-no-files-found: ignore
          retention-days: 14
      - name: Failure note
        if: failure()
        shell: bash
        run: |
          echo "If this looks like Namespace runner Nix store corruption (e.g. \"... is not valid\", \"config.cachix\", \"cachix.package\"), add the run link + full nix-store output to:"
          echo "  https://github.com/overengineeringstudio/effect-utils/issues/201"
  test:
    strategy:
      fail-fast: false
      matrix:
        runner: [namespace-profile-linux-x86-64, namespace-profile-macos-arm64]
    runs-on: ['${{ matrix.runner }}', 'namespace-features:github.run-id=${{ github.run_id }}']
    defaults:
      run:
        shell: bash
    env:
      FORCE_SETUP: '1'
      CI: 'true'
      GITHUB_TOKEN: '${{ github.token }}'
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            extra-substituters = https://devenv.cachix.org
            extra-trusted-public-keys = devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw=
            access-tokens = github.com=${{ github.token }}
      - name: Enable Cachix cache
        uses: cachix/cachix-action@v16
        with:
          name: overeng-effect-utils
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      - name: Use pinned devenv from lock
        run: |
          DEVENV_REV=$(jq -r .nodes.devenv.locked.rev devenv.lock)
          if [ -z "$DEVENV_REV" ] || [ "$DEVENV_REV" = "null" ]; then
            echo '::error::devenv.lock missing .nodes.devenv.locked.rev'
            exit 1
          fi
          echo "DEVENV_REV=$DEVENV_REV" >> "$GITHUB_ENV"
          echo "Pinned devenv rev: $DEVENV_REV"
        shell: bash
      - name: Validate Nix store
        run: |
          if [ -z "${DEVENV_REV:-}" ]; then
            DEVENV_REV=$(jq -r .nodes.devenv.locked.rev devenv.lock)
          if [ -z "$DEVENV_REV" ] || [ "$DEVENV_REV" = "null" ]; then
            echo '::error::devenv.lock missing .nodes.devenv.locked.rev'
            exit 1
          fi
          fi

          resolve_devenv() {
            nix build --no-link --print-out-paths "github:cachix/devenv/$DEVENV_REV#devenv"
          }

          # Always append restrict-eval=false so caller-provided NIX_CONFIG keeps its settings.
          if [ -n "${NIX_CONFIG:-}" ]; then
            NIX_CONFIG_WITH_UNRESTRICTED_EVAL="$NIX_CONFIG"$'\n''restrict-eval = false'
          else
            NIX_CONFIG_WITH_UNRESTRICTED_EVAL='restrict-eval = false'
          fi

          # Temporary: capture complete diagnostics for #272 root-cause analysis.
          DIAG_ROOT="${RUNNER_TEMP:-/tmp}/nix-store-diagnostics-${GITHUB_JOB:-job}-${RUNNER_OS:-unknown}-${GITHUB_RUN_ATTEMPT:-0}"
          mkdir -p "$DIAG_ROOT"
          echo "NIX_STORE_DIAGNOSTICS_DIR=$DIAG_ROOT" >> "$GITHUB_ENV"

          {
            echo "timestamp_utc=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "runner_name=${RUNNER_NAME:-unknown}"
            echo "runner_os=${RUNNER_OS:-unknown}"
            echo "runner_arch=${RUNNER_ARCH:-unknown}"
            echo "github_job=${GITHUB_JOB:-unknown}"
            echo "github_run_id=${GITHUB_RUN_ID:-unknown}"
            echo "github_run_attempt=${GITHUB_RUN_ATTEMPT:-unknown}"
            echo "nix_user_conf_files=${NIX_USER_CONF_FILES:-}"
            echo ""
            echo "== uname -a =="
            uname -a || true
            if command -v sw_vers > /dev/null 2>&1; then
              echo ""
              echo "== sw_vers =="
              sw_vers || true
            fi
            echo ""
            echo "== nix --version =="
            nix --version || true
          } > "$DIAG_ROOT/environment.txt" 2>&1

          pre_resolve_log="$DIAG_ROOT/resolve-devenv-pre-repair.log"
          pre_info_log="$DIAG_ROOT/devenv-info-pre-repair.log"
          verify_log="$DIAG_ROOT/nix-store-verify-pre-repair.log"
          repair_log="$DIAG_ROOT/nix-store-verify-repair.log"
          post_resolve_log="$DIAG_ROOT/resolve-devenv-post-repair.log"
          post_info_log="$DIAG_ROOT/devenv-info-post-repair.log"

          if DEVENV_OUT=$(resolve_devenv 2>"$pre_resolve_log") && DEVENV_BIN="$DEVENV_OUT/bin/devenv" && NIX_CONFIG="$NIX_CONFIG_WITH_UNRESTRICTED_EVAL" "$DEVENV_BIN" info > "$pre_info_log" 2>&1; then
            echo "Nix store OK"
          else
            echo "::warning::Nix store validation failed, collecting diagnostics and repairing..."
            if ! nix-store --verify --check-contents > "$verify_log" 2>&1; then
              echo "::warning::nix-store --verify --check-contents reported issues (see diagnostics artifact)"
            fi
            if ! nix-store --verify --check-contents --repair > "$repair_log" 2>&1; then
              echo "::warning::nix-store --verify --check-contents --repair reported issues (see diagnostics artifact)"
            fi
            rm -rf ~/.cache/nix/eval-cache-*
            DEVENV_OUT=$(resolve_devenv 2>"$post_resolve_log")
            DEVENV_BIN="$DEVENV_OUT/bin/devenv"
            NIX_CONFIG="$NIX_CONFIG_WITH_UNRESTRICTED_EVAL" "$DEVENV_BIN" info > "$post_info_log" 2>&1
          fi

          echo "DEVENV_BIN=$DEVENV_BIN" >> "$GITHUB_ENV"
          "$DEVENV_BIN" version | tee "$DIAG_ROOT/devenv-version.txt"
        shell: bash
      - name: Unit tests
        run: "if [ -n \"${NIX_CONFIG:-}\" ]; then NIX_CONFIG_WITH_UNRESTRICTED_EVAL=\"$NIX_CONFIG\"$'\\n''restrict-eval = false'; else NIX_CONFIG_WITH_UNRESTRICTED_EVAL='restrict-eval = false'; fi; NIX_CONFIG=\"$NIX_CONFIG_WITH_UNRESTRICTED_EVAL\" \"${DEVENV_BIN:?DEVENV_BIN not set}\" tasks run test:run --mode before"
      - name: Nix diagnostics summary
        if: failure()
        shell: bash
        run: |
          diag_dir="${NIX_STORE_DIAGNOSTICS_DIR:-}"
          if [ -z "$diag_dir" ] || [ ! -d "$diag_dir" ]; then
            echo "## Nix Store Diagnostics" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "No diagnostics directory found (validation may have failed before capture)." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          {
            echo "## Nix Store Diagnostics"
            echo ""
            echo "Temporary instrumentation for #272; remove after root cause is confirmed and CI is stable."
            echo ""
            echo "- Diagnostics directory: `$diag_dir`"
            echo "- Tracking issue: https://github.com/overengineeringstudio/effect-utils/issues/272"
          } >> "$GITHUB_STEP_SUMMARY"

          markers_file="$diag_dir/signature-markers.txt"
          grep -R -n -E "config\\.cachix|cachix\\.package|error: path '/nix/store/.+ is not valid" "$diag_dir" > "$markers_file" || true

          if [ -s "$markers_file" ]; then
            {
              echo ""
              echo "### Signature markers"
              echo "```text"
              sed -n "1,120p" "$markers_file"
              echo "```"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- No signature markers found in captured diagnostics." >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Upload Nix diagnostics artifact
        if: failure() && env.NIX_STORE_DIAGNOSTICS_DIR != ''
        uses: actions/upload-artifact@v4
        with:
          name: 'nix-store-diagnostics-${{ github.job }}-${{ runner.os }}-run-${{ github.run_id }}-attempt-${{ github.run_attempt }}'
          path: '${{ env.NIX_STORE_DIAGNOSTICS_DIR }}'
          if-no-files-found: ignore
          retention-days: 14
      - name: Failure note
        if: failure()
        shell: bash
        run: |
          echo "If this looks like Namespace runner Nix store corruption (e.g. \"... is not valid\", \"config.cachix\", \"cachix.package\"), add the run link + full nix-store output to:"
          echo "  https://github.com/overengineeringstudio/effect-utils/issues/201"
  nix-check:
    strategy:
      fail-fast: false
      matrix:
        runner: [namespace-profile-linux-x86-64, namespace-profile-macos-arm64]
    runs-on: ['${{ matrix.runner }}', 'namespace-features:github.run-id=${{ github.run_id }}']
    defaults:
      run:
        shell: bash
    env:
      FORCE_SETUP: '1'
      CI: 'true'
      GITHUB_TOKEN: '${{ github.token }}'
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            extra-substituters = https://devenv.cachix.org
            extra-trusted-public-keys = devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw=
            access-tokens = github.com=${{ github.token }}
      - name: Enable Cachix cache
        uses: cachix/cachix-action@v16
        with:
          name: overeng-effect-utils
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      - name: Use pinned devenv from lock
        run: |
          DEVENV_REV=$(jq -r .nodes.devenv.locked.rev devenv.lock)
          if [ -z "$DEVENV_REV" ] || [ "$DEVENV_REV" = "null" ]; then
            echo '::error::devenv.lock missing .nodes.devenv.locked.rev'
            exit 1
          fi
          echo "DEVENV_REV=$DEVENV_REV" >> "$GITHUB_ENV"
          echo "Pinned devenv rev: $DEVENV_REV"
        shell: bash
      - name: Validate Nix store
        run: |
          if [ -z "${DEVENV_REV:-}" ]; then
            DEVENV_REV=$(jq -r .nodes.devenv.locked.rev devenv.lock)
          if [ -z "$DEVENV_REV" ] || [ "$DEVENV_REV" = "null" ]; then
            echo '::error::devenv.lock missing .nodes.devenv.locked.rev'
            exit 1
          fi
          fi

          resolve_devenv() {
            nix build --no-link --print-out-paths "github:cachix/devenv/$DEVENV_REV#devenv"
          }

          # Always append restrict-eval=false so caller-provided NIX_CONFIG keeps its settings.
          if [ -n "${NIX_CONFIG:-}" ]; then
            NIX_CONFIG_WITH_UNRESTRICTED_EVAL="$NIX_CONFIG"$'\n''restrict-eval = false'
          else
            NIX_CONFIG_WITH_UNRESTRICTED_EVAL='restrict-eval = false'
          fi

          # Temporary: capture complete diagnostics for #272 root-cause analysis.
          DIAG_ROOT="${RUNNER_TEMP:-/tmp}/nix-store-diagnostics-${GITHUB_JOB:-job}-${RUNNER_OS:-unknown}-${GITHUB_RUN_ATTEMPT:-0}"
          mkdir -p "$DIAG_ROOT"
          echo "NIX_STORE_DIAGNOSTICS_DIR=$DIAG_ROOT" >> "$GITHUB_ENV"

          {
            echo "timestamp_utc=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "runner_name=${RUNNER_NAME:-unknown}"
            echo "runner_os=${RUNNER_OS:-unknown}"
            echo "runner_arch=${RUNNER_ARCH:-unknown}"
            echo "github_job=${GITHUB_JOB:-unknown}"
            echo "github_run_id=${GITHUB_RUN_ID:-unknown}"
            echo "github_run_attempt=${GITHUB_RUN_ATTEMPT:-unknown}"
            echo "nix_user_conf_files=${NIX_USER_CONF_FILES:-}"
            echo ""
            echo "== uname -a =="
            uname -a || true
            if command -v sw_vers > /dev/null 2>&1; then
              echo ""
              echo "== sw_vers =="
              sw_vers || true
            fi
            echo ""
            echo "== nix --version =="
            nix --version || true
          } > "$DIAG_ROOT/environment.txt" 2>&1

          pre_resolve_log="$DIAG_ROOT/resolve-devenv-pre-repair.log"
          pre_info_log="$DIAG_ROOT/devenv-info-pre-repair.log"
          verify_log="$DIAG_ROOT/nix-store-verify-pre-repair.log"
          repair_log="$DIAG_ROOT/nix-store-verify-repair.log"
          post_resolve_log="$DIAG_ROOT/resolve-devenv-post-repair.log"
          post_info_log="$DIAG_ROOT/devenv-info-post-repair.log"

          if DEVENV_OUT=$(resolve_devenv 2>"$pre_resolve_log") && DEVENV_BIN="$DEVENV_OUT/bin/devenv" && NIX_CONFIG="$NIX_CONFIG_WITH_UNRESTRICTED_EVAL" "$DEVENV_BIN" info > "$pre_info_log" 2>&1; then
            echo "Nix store OK"
          else
            echo "::warning::Nix store validation failed, collecting diagnostics and repairing..."
            if ! nix-store --verify --check-contents > "$verify_log" 2>&1; then
              echo "::warning::nix-store --verify --check-contents reported issues (see diagnostics artifact)"
            fi
            if ! nix-store --verify --check-contents --repair > "$repair_log" 2>&1; then
              echo "::warning::nix-store --verify --check-contents --repair reported issues (see diagnostics artifact)"
            fi
            rm -rf ~/.cache/nix/eval-cache-*
            DEVENV_OUT=$(resolve_devenv 2>"$post_resolve_log")
            DEVENV_BIN="$DEVENV_OUT/bin/devenv"
            NIX_CONFIG="$NIX_CONFIG_WITH_UNRESTRICTED_EVAL" "$DEVENV_BIN" info > "$post_info_log" 2>&1
          fi

          echo "DEVENV_BIN=$DEVENV_BIN" >> "$GITHUB_ENV"
          "$DEVENV_BIN" version | tee "$DIAG_ROOT/devenv-version.txt"
        shell: bash
      - name: Nix hash check
        run: "if [ -n \"${NIX_CONFIG:-}\" ]; then NIX_CONFIG_WITH_UNRESTRICTED_EVAL=\"$NIX_CONFIG\"$'\\n''restrict-eval = false'; else NIX_CONFIG_WITH_UNRESTRICTED_EVAL='restrict-eval = false'; fi; NIX_CONFIG=\"$NIX_CONFIG_WITH_UNRESTRICTED_EVAL\" \"${DEVENV_BIN:?DEVENV_BIN not set}\" tasks run nix:check --mode before"
      - name: Nix diagnostics summary
        if: failure()
        shell: bash
        run: |
          diag_dir="${NIX_STORE_DIAGNOSTICS_DIR:-}"
          if [ -z "$diag_dir" ] || [ ! -d "$diag_dir" ]; then
            echo "## Nix Store Diagnostics" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "No diagnostics directory found (validation may have failed before capture)." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          {
            echo "## Nix Store Diagnostics"
            echo ""
            echo "Temporary instrumentation for #272; remove after root cause is confirmed and CI is stable."
            echo ""
            echo "- Diagnostics directory: `$diag_dir`"
            echo "- Tracking issue: https://github.com/overengineeringstudio/effect-utils/issues/272"
          } >> "$GITHUB_STEP_SUMMARY"

          markers_file="$diag_dir/signature-markers.txt"
          grep -R -n -E "config\\.cachix|cachix\\.package|error: path '/nix/store/.+ is not valid" "$diag_dir" > "$markers_file" || true

          if [ -s "$markers_file" ]; then
            {
              echo ""
              echo "### Signature markers"
              echo "```text"
              sed -n "1,120p" "$markers_file"
              echo "```"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- No signature markers found in captured diagnostics." >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Upload Nix diagnostics artifact
        if: failure() && env.NIX_STORE_DIAGNOSTICS_DIR != ''
        uses: actions/upload-artifact@v4
        with:
          name: 'nix-store-diagnostics-${{ github.job }}-${{ runner.os }}-run-${{ github.run_id }}-attempt-${{ github.run_attempt }}'
          path: '${{ env.NIX_STORE_DIAGNOSTICS_DIR }}'
          if-no-files-found: ignore
          retention-days: 14
      - name: Failure note
        if: failure()
        shell: bash
        run: |
          echo "If this looks like Namespace runner Nix store corruption (e.g. \"... is not valid\", \"config.cachix\", \"cachix.package\"), add the run link + full nix-store output to:"
          echo "  https://github.com/overengineeringstudio/effect-utils/issues/201"
  deploy-storybooks:
    runs-on:
      [namespace-profile-linux-x86-64, 'namespace-features:github.run-id=${{ github.run_id }}']
    permissions:
      contents: read
      pull-requests: write
    defaults:
      run:
        shell: bash
    env:
      FORCE_SETUP: '1'
      CI: 'true'
      GITHUB_TOKEN: '${{ github.token }}'
      NETLIFY_AUTH_TOKEN: '${{ secrets.NETLIFY_AUTH_TOKEN }}'
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: DeterminateSystems/determinate-nix-action@v3
        with:
          extra-conf: |
            extra-substituters = https://devenv.cachix.org
            extra-trusted-public-keys = devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw=
            access-tokens = github.com=${{ github.token }}
      - name: Enable Cachix cache
        uses: cachix/cachix-action@v16
        with:
          name: overeng-effect-utils
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      - name: Use pinned devenv from lock
        run: |
          DEVENV_REV=$(jq -r .nodes.devenv.locked.rev devenv.lock)
          if [ -z "$DEVENV_REV" ] || [ "$DEVENV_REV" = "null" ]; then
            echo '::error::devenv.lock missing .nodes.devenv.locked.rev'
            exit 1
          fi
          echo "DEVENV_REV=$DEVENV_REV" >> "$GITHUB_ENV"
          echo "Pinned devenv rev: $DEVENV_REV"
        shell: bash
      - name: Validate Nix store
        run: |
          if [ -z "${DEVENV_REV:-}" ]; then
            DEVENV_REV=$(jq -r .nodes.devenv.locked.rev devenv.lock)
          if [ -z "$DEVENV_REV" ] || [ "$DEVENV_REV" = "null" ]; then
            echo '::error::devenv.lock missing .nodes.devenv.locked.rev'
            exit 1
          fi
          fi

          resolve_devenv() {
            nix build --no-link --print-out-paths "github:cachix/devenv/$DEVENV_REV#devenv"
          }

          # Always append restrict-eval=false so caller-provided NIX_CONFIG keeps its settings.
          if [ -n "${NIX_CONFIG:-}" ]; then
            NIX_CONFIG_WITH_UNRESTRICTED_EVAL="$NIX_CONFIG"$'\n''restrict-eval = false'
          else
            NIX_CONFIG_WITH_UNRESTRICTED_EVAL='restrict-eval = false'
          fi

          # Temporary: capture complete diagnostics for #272 root-cause analysis.
          DIAG_ROOT="${RUNNER_TEMP:-/tmp}/nix-store-diagnostics-${GITHUB_JOB:-job}-${RUNNER_OS:-unknown}-${GITHUB_RUN_ATTEMPT:-0}"
          mkdir -p "$DIAG_ROOT"
          echo "NIX_STORE_DIAGNOSTICS_DIR=$DIAG_ROOT" >> "$GITHUB_ENV"

          {
            echo "timestamp_utc=$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "runner_name=${RUNNER_NAME:-unknown}"
            echo "runner_os=${RUNNER_OS:-unknown}"
            echo "runner_arch=${RUNNER_ARCH:-unknown}"
            echo "github_job=${GITHUB_JOB:-unknown}"
            echo "github_run_id=${GITHUB_RUN_ID:-unknown}"
            echo "github_run_attempt=${GITHUB_RUN_ATTEMPT:-unknown}"
            echo "nix_user_conf_files=${NIX_USER_CONF_FILES:-}"
            echo ""
            echo "== uname -a =="
            uname -a || true
            if command -v sw_vers > /dev/null 2>&1; then
              echo ""
              echo "== sw_vers =="
              sw_vers || true
            fi
            echo ""
            echo "== nix --version =="
            nix --version || true
          } > "$DIAG_ROOT/environment.txt" 2>&1

          pre_resolve_log="$DIAG_ROOT/resolve-devenv-pre-repair.log"
          pre_info_log="$DIAG_ROOT/devenv-info-pre-repair.log"
          verify_log="$DIAG_ROOT/nix-store-verify-pre-repair.log"
          repair_log="$DIAG_ROOT/nix-store-verify-repair.log"
          post_resolve_log="$DIAG_ROOT/resolve-devenv-post-repair.log"
          post_info_log="$DIAG_ROOT/devenv-info-post-repair.log"

          if DEVENV_OUT=$(resolve_devenv 2>"$pre_resolve_log") && DEVENV_BIN="$DEVENV_OUT/bin/devenv" && NIX_CONFIG="$NIX_CONFIG_WITH_UNRESTRICTED_EVAL" "$DEVENV_BIN" info > "$pre_info_log" 2>&1; then
            echo "Nix store OK"
          else
            echo "::warning::Nix store validation failed, collecting diagnostics and repairing..."
            if ! nix-store --verify --check-contents > "$verify_log" 2>&1; then
              echo "::warning::nix-store --verify --check-contents reported issues (see diagnostics artifact)"
            fi
            if ! nix-store --verify --check-contents --repair > "$repair_log" 2>&1; then
              echo "::warning::nix-store --verify --check-contents --repair reported issues (see diagnostics artifact)"
            fi
            rm -rf ~/.cache/nix/eval-cache-*
            DEVENV_OUT=$(resolve_devenv 2>"$post_resolve_log")
            DEVENV_BIN="$DEVENV_OUT/bin/devenv"
            NIX_CONFIG="$NIX_CONFIG_WITH_UNRESTRICTED_EVAL" "$DEVENV_BIN" info > "$post_info_log" 2>&1
          fi

          echo "DEVENV_BIN=$DEVENV_BIN" >> "$GITHUB_ENV"
          "$DEVENV_BIN" version | tee "$DIAG_ROOT/devenv-version.txt"
        shell: bash
      - name: Deploy storybooks to Netlify
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            if [ -n "${NIX_CONFIG:-}" ]; then NIX_CONFIG_WITH_UNRESTRICTED_EVAL="$NIX_CONFIG"$'\n''restrict-eval = false'; else NIX_CONFIG_WITH_UNRESTRICTED_EVAL='restrict-eval = false'; fi; NIX_CONFIG="$NIX_CONFIG_WITH_UNRESTRICTED_EVAL" "${DEVENV_BIN:?DEVENV_BIN not set}" tasks run netlify:deploy --input type=prod --mode before
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            if [ -n "${NIX_CONFIG:-}" ]; then NIX_CONFIG_WITH_UNRESTRICTED_EVAL="$NIX_CONFIG"$'\n''restrict-eval = false'; else NIX_CONFIG_WITH_UNRESTRICTED_EVAL='restrict-eval = false'; fi; NIX_CONFIG="$NIX_CONFIG_WITH_UNRESTRICTED_EVAL" "${DEVENV_BIN:?DEVENV_BIN not set}" tasks run netlify:deploy --input type=pr --input pr=${{ github.event.pull_request.number }} --mode before
          fi
      - name: Post deploy URLs
        if: always() && !cancelled()
        shell: bash
        env:
          GH_TOKEN: '${{ github.token }}'
        run: |
          site="overeng-utils"
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            suffix=""
            label="prod"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            suffix="-pr-${{ github.event.pull_request.number }}"
            label="PR #${{ github.event.pull_request.number }}"
          else
            exit 0
          fi

          # Collect deployed storybooks by checking for build output
          rows=""
          for dir in packages/@overeng/*/storybook-static; do
            [ -d "$dir" ] || continue
            name="${dir#packages/@overeng/}"
            name="${name%/storybook-static}"
            url="https://${name}${suffix}--${site}.netlify.app"
            rows="${rows}| ${name} | ${url} |\n"
          done

          if [ -z "$rows" ]; then
            echo "No storybooks were deployed." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          # Write job summary
          {
            echo "## Storybook Previews (${label})"
            echo ""
            echo "| Package | URL |"
            echo "| --- | --- |"
            echo -e "$rows"
          } >> "$GITHUB_STEP_SUMMARY"

          # Post/update PR comment
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            {
              echo "## Storybook Previews"
              echo ""
              echo "| Package | URL |"
              echo "| --- | --- |"
              echo -e "$rows"
            } > /tmp/comment.md
            gh pr comment "${{ github.event.pull_request.number }}" --body-file /tmp/comment.md --edit-last 2>/dev/null \
              || gh pr comment "${{ github.event.pull_request.number }}" --body-file /tmp/comment.md
          fi
      - name: Nix diagnostics summary
        if: failure()
        shell: bash
        run: |
          diag_dir="${NIX_STORE_DIAGNOSTICS_DIR:-}"
          if [ -z "$diag_dir" ] || [ ! -d "$diag_dir" ]; then
            echo "## Nix Store Diagnostics" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "No diagnostics directory found (validation may have failed before capture)." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          {
            echo "## Nix Store Diagnostics"
            echo ""
            echo "Temporary instrumentation for #272; remove after root cause is confirmed and CI is stable."
            echo ""
            echo "- Diagnostics directory: `$diag_dir`"
            echo "- Tracking issue: https://github.com/overengineeringstudio/effect-utils/issues/272"
          } >> "$GITHUB_STEP_SUMMARY"

          markers_file="$diag_dir/signature-markers.txt"
          grep -R -n -E "config\\.cachix|cachix\\.package|error: path '/nix/store/.+ is not valid" "$diag_dir" > "$markers_file" || true

          if [ -s "$markers_file" ]; then
            {
              echo ""
              echo "### Signature markers"
              echo "```text"
              sed -n "1,120p" "$markers_file"
              echo "```"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "- No signature markers found in captured diagnostics." >> "$GITHUB_STEP_SUMMARY"
          fi
      - name: Upload Nix diagnostics artifact
        if: failure() && env.NIX_STORE_DIAGNOSTICS_DIR != ''
        uses: actions/upload-artifact@v4
        with:
          name: 'nix-store-diagnostics-${{ github.job }}-${{ runner.os }}-run-${{ github.run_id }}-attempt-${{ github.run_attempt }}'
          path: '${{ env.NIX_STORE_DIAGNOSTICS_DIR }}'
          if-no-files-found: ignore
          retention-days: 14
      - name: Failure note
        if: failure()
        shell: bash
        run: |
          echo "If this looks like Namespace runner Nix store corruption (e.g. \"... is not valid\", \"config.cachix\", \"cachix.package\"), add the run link + full nix-store output to:"
          echo "  https://github.com/overengineeringstudio/effect-utils/issues/201"
