# megarepo

Megarepo (`mr`) is a tool for composing multiple git repositories into a unified development environment. It manages a global store of bare repos with worktrees, creates symlinks into your workspace, and tracks exact commits in a lock file for reproducible CI builds.

## Why megarepo?

- **Shared worktrees** - Multiple projects can share the same checkout, saving disk space and keeping changes in sync
- **Lock file for CI** - `megarepo.lock` records exact commits for reproducible builds with `mr sync --frozen`
- **Simple config** - Just a `megarepo.json` with member names and GitHub shorthand or URLs
- **No runtime overhead** - Pure git worktrees and symlinks; members don't know they're in a megarepo

## Quick Start

```bash
# Initialize a new megarepo
mr init

# Add a member (supports GitHub shorthand, URLs, or local paths)
mr add effect-ts/effect
mr add effect-ts/effect#v3.0.0 --name effect-v3
mr add ./packages/local-lib --name local-lib

# Sync all members (clone/update worktrees, create symlinks)
mr sync

# Update members to latest commits
mr update
```

## Commands

| Command              | Description                                                   |
| -------------------- | ------------------------------------------------------------- |
| `mr init`            | Initialize a new megarepo in current directory                |
| `mr add <repo>`      | Add a member to megarepo.json                                 |
| `mr sync`            | Ensure worktrees exist and symlinks are correct               |
| `mr sync --frozen`   | CI mode: fail if lock is missing or stale                     |
| `mr update [member]` | Fetch latest commits and update lock file                     |
| `mr status`          | Show megarepo state                                           |
| `mr ls`              | List members                                                  |
| `mr pin <member>`    | Pin member to current commit (skip during update)             |
| `mr unpin <member>`  | Unpin member                                                  |
| `mr exec <cmd>`      | Run command across all members                                |
| `mr store ls`        | List repos in global store                                    |
| `mr store gc`        | Remove unused worktrees                                       |
| `mr generate all`    | Generate Nix workspace, .envrc.generated.megarepo, and extras |
| `mr generate nix`    | Generate Nix workspace + .envrc.generated.megarepo            |

## Source Formats

```json
{
  "members": {
    "effect": "effect-ts/effect", // GitHub shorthand, default branch
    "effect-v3": "effect-ts/effect#v3.0.0", // specific tag
    "effect-next": "effect-ts/effect#next", // specific branch
    "gitlab-lib": "https://gitlab.com/org/repo",
    "local-lib": "./packages/local" // local path (not in lock file)
  }
}
```

## Directory Layout

After `mr sync`:

```
my-megarepo/
├── megarepo.json              # Config (committed)
├── megarepo.lock              # Lock file (committed for CI)
├── .envrc.generated.megarepo               # Generated by mr generate nix
├── .direnv/megarepo-nix/workspace/ # Generated Nix workspace
└── repos/
    ├── effect -> ~/.megarepo/github.com/effect-ts/effect/refs/heads/main/
    ├── effect-v3 -> ~/.megarepo/github.com/effect-ts/effect/refs/tags/v3.0.0/
    └── local-lib/             # Local path: actual directory, not symlink
```

## Documentation

- [Getting Started](docs/getting-started.md) - Installation and first megarepo setup
- [Commands Reference](docs/commands.md) - Complete CLI documentation
- [Workflows](docs/workflows.md) - Common usage patterns
- [Specification](docs/spec.md) - Technical specification

### Integrations

- [Bun](docs/integrations/bun.md) - Package manager workspace setup
- [TypeScript](docs/integrations/typescript.md) - Cross-repo type paths

## Environment Variables

| Variable                  | Description                     | Default       |
| ------------------------- | ------------------------------- | ------------- |
| `MEGAREPO_ROOT_OUTERMOST` | Path to outermost megarepo root | Auto-detected |
| `MEGAREPO_ROOT_NEAREST`   | Path to nearest megarepo root   | Auto-detected |
| `MEGAREPO_STORE`          | Global store location           | `~/.megarepo` |
| `MEGAREPO_MEMBERS`        | Comma-separated member names    | From config   |

## License

MIT
