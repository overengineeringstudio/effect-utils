if has devenv && test -f megarepo.json; then
  if [ ! -f ./.envrc.generated.megarepo ] || [ megarepo.json -nt ./.envrc.generated.megarepo ] || [ ! -f ./.direnv/megarepo-nix/workspace/flake.nix ]; then
    mr_cli="./packages/@overeng/megarepo/bin/mr.ts"
    if [ ! -f "$mr_cli" ]; then
      mr_cli="./repos/effect-utils/packages/@overeng/megarepo/bin/mr.ts"
    fi
    if [ -f "$mr_cli" ]; then
      bun "$mr_cli" generate nix --deep
    else
      echo "[direnv] mr CLI not found. Run pnpm install in effect-utils." >&2
      exit 1
    fi
  fi
fi

source_env_if_exists ./.envrc.generated.megarepo

use devenv
