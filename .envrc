#!/usr/bin/env bash

if command -v nix-shell &> /dev/null
then
  eval "$(devenv direnvrc)"
  use devenv
fi

export WORKSPACE_ROOT=$(pwd)

# Runtime CLI stamp for local builds (rev+YYYYMMDDHHmmss[-dirty]).
export NIX_CLI_BUILD_STAMP=$(
  rev=$(git -C "$WORKSPACE_ROOT" rev-parse --short HEAD 2>/dev/null || echo "unknown")
  ts=$(date -u +%Y%m%d%H%M%S)
  stamp="${rev}+${ts}"
  if [ "$rev" != "unknown" ] && [ -n "$(git -C "$WORKSPACE_ROOT" status --porcelain 2>/dev/null)" ]; then
    stamp="${stamp}-dirty"
  fi
  echo "$stamp"
)

if test -f ./.envrc.local; then
  source_env ./.envrc.local
fi
